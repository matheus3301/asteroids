package game

import (
	"image/color"

	"github.com/hajimehoshi/ebiten/v2"
	"github.com/hajimehoshi/ebiten/v2/vector"
)

// Each glyph is defined as line segments in a 5Ã—7 grid.
// Segment format: {x1, y1, x2, y2}
var fontGlyphs = map[rune][][4]float64{
	'A': {
		{0, 7, 0, 2}, {0, 2, 2.5, 0}, {2.5, 0, 5, 2}, {5, 2, 5, 7},
		{0, 4, 5, 4},
	},
	'B': {
		{0, 0, 0, 7}, {0, 0, 4, 0}, {4, 0, 5, 1}, {5, 1, 5, 3},
		{5, 3, 4, 3.5}, {4, 3.5, 0, 3.5}, {4, 3.5, 5, 4.5}, {5, 4.5, 5, 6},
		{5, 6, 4, 7}, {4, 7, 0, 7},
	},
	'C': {
		{5, 1, 4, 0}, {4, 0, 1, 0}, {1, 0, 0, 1}, {0, 1, 0, 6},
		{0, 6, 1, 7}, {1, 7, 4, 7}, {4, 7, 5, 6},
	},
	'D': {
		{0, 0, 0, 7}, {0, 0, 3, 0}, {3, 0, 5, 2}, {5, 2, 5, 5},
		{5, 5, 3, 7}, {3, 7, 0, 7},
	},
	'E': {
		{5, 0, 0, 0}, {0, 0, 0, 7}, {0, 7, 5, 7}, {0, 3.5, 3, 3.5},
	},
	'F': {
		{5, 0, 0, 0}, {0, 0, 0, 7}, {0, 3.5, 3, 3.5},
	},
	'G': {
		{5, 1, 4, 0}, {4, 0, 1, 0}, {1, 0, 0, 1}, {0, 1, 0, 6},
		{0, 6, 1, 7}, {1, 7, 4, 7}, {4, 7, 5, 6}, {5, 6, 5, 3.5},
		{5, 3.5, 3, 3.5},
	},
	'H': {
		{0, 0, 0, 7}, {5, 0, 5, 7}, {0, 3.5, 5, 3.5},
	},
	'I': {
		{1, 0, 4, 0}, {2.5, 0, 2.5, 7}, {1, 7, 4, 7},
	},
	'J': {
		{2, 0, 5, 0}, {5, 0, 5, 6}, {5, 6, 4, 7}, {4, 7, 1, 7},
		{1, 7, 0, 6},
	},
	'K': {
		{0, 0, 0, 7}, {5, 0, 0, 3.5}, {0, 3.5, 5, 7},
	},
	'L': {
		{0, 0, 0, 7}, {0, 7, 5, 7},
	},
	'M': {
		{0, 7, 0, 0}, {0, 0, 2.5, 3}, {2.5, 3, 5, 0}, {5, 0, 5, 7},
	},
	'N': {
		{0, 7, 0, 0}, {0, 0, 5, 7}, {5, 7, 5, 0},
	},
	'O': {
		{1, 0, 4, 0}, {4, 0, 5, 1}, {5, 1, 5, 6}, {5, 6, 4, 7},
		{4, 7, 1, 7}, {1, 7, 0, 6}, {0, 6, 0, 1}, {0, 1, 1, 0},
	},
	'P': {
		{0, 7, 0, 0}, {0, 0, 4, 0}, {4, 0, 5, 1}, {5, 1, 5, 3},
		{5, 3, 4, 4}, {4, 4, 0, 4},
	},
	'Q': {
		{1, 0, 4, 0}, {4, 0, 5, 1}, {5, 1, 5, 6}, {5, 6, 4, 7},
		{4, 7, 1, 7}, {1, 7, 0, 6}, {0, 6, 0, 1}, {0, 1, 1, 0},
		{3, 5, 5, 7},
	},
	'R': {
		{0, 7, 0, 0}, {0, 0, 4, 0}, {4, 0, 5, 1}, {5, 1, 5, 3},
		{5, 3, 4, 4}, {4, 4, 0, 4}, {3, 4, 5, 7},
	},
	'S': {
		{5, 1, 4, 0}, {4, 0, 1, 0}, {1, 0, 0, 1}, {0, 1, 0, 3},
		{0, 3, 1, 3.5}, {1, 3.5, 4, 3.5}, {4, 3.5, 5, 4.5},
		{5, 4.5, 5, 6}, {5, 6, 4, 7}, {4, 7, 1, 7}, {1, 7, 0, 6},
	},
	'T': {
		{0, 0, 5, 0}, {2.5, 0, 2.5, 7},
	},
	'U': {
		{0, 0, 0, 6}, {0, 6, 1, 7}, {1, 7, 4, 7}, {4, 7, 5, 6},
		{5, 6, 5, 0},
	},
	'V': {
		{0, 0, 2.5, 7}, {2.5, 7, 5, 0},
	},
	'W': {
		{0, 0, 0, 7}, {0, 7, 2.5, 4}, {2.5, 4, 5, 7}, {5, 7, 5, 0},
	},
	'X': {
		{0, 0, 5, 7}, {5, 0, 0, 7},
	},
	'Y': {
		{0, 0, 2.5, 3.5}, {5, 0, 2.5, 3.5}, {2.5, 3.5, 2.5, 7},
	},
	'Z': {
		{0, 0, 5, 0}, {5, 0, 0, 7}, {0, 7, 5, 7},
	},
	'0': {
		{1, 0, 4, 0}, {4, 0, 5, 1}, {5, 1, 5, 6}, {5, 6, 4, 7},
		{4, 7, 1, 7}, {1, 7, 0, 6}, {0, 6, 0, 1}, {0, 1, 1, 0},
		{0, 7, 5, 0},
	},
	'1': {
		{1.5, 1, 2.5, 0}, {2.5, 0, 2.5, 7}, {1, 7, 4, 7},
	},
	'2': {
		{0, 1, 1, 0}, {1, 0, 4, 0}, {4, 0, 5, 1}, {5, 1, 5, 3},
		{5, 3, 0, 7}, {0, 7, 5, 7},
	},
	'3': {
		{0, 1, 1, 0}, {1, 0, 4, 0}, {4, 0, 5, 1}, {5, 1, 5, 3},
		{5, 3, 4, 3.5}, {4, 3.5, 2, 3.5}, {4, 3.5, 5, 4.5},
		{5, 4.5, 5, 6}, {5, 6, 4, 7}, {4, 7, 1, 7}, {1, 7, 0, 6},
	},
	'4': {
		{0, 0, 0, 3.5}, {0, 3.5, 5, 3.5}, {5, 0, 5, 7},
	},
	'5': {
		{5, 0, 0, 0}, {0, 0, 0, 3.5}, {0, 3.5, 4, 3.5},
		{4, 3.5, 5, 4.5}, {5, 4.5, 5, 6}, {5, 6, 4, 7},
		{4, 7, 1, 7}, {1, 7, 0, 6},
	},
	'6': {
		{4, 0, 1, 0}, {1, 0, 0, 1}, {0, 1, 0, 6}, {0, 6, 1, 7},
		{1, 7, 4, 7}, {4, 7, 5, 6}, {5, 6, 5, 4.5}, {5, 4.5, 4, 3.5},
		{4, 3.5, 0, 3.5},
	},
	'7': {
		{0, 0, 5, 0}, {5, 0, 2, 7},
	},
	'8': {
		{1, 0, 4, 0}, {4, 0, 5, 1}, {5, 1, 5, 3}, {5, 3, 4, 3.5},
		{4, 3.5, 1, 3.5}, {1, 3.5, 0, 3}, {0, 3, 0, 1}, {0, 1, 1, 0},
		{1, 3.5, 0, 4.5}, {0, 4.5, 0, 6}, {0, 6, 1, 7}, {1, 7, 4, 7},
		{4, 7, 5, 6}, {5, 6, 5, 4.5}, {5, 4.5, 4, 3.5},
	},
	'9': {
		{5, 3.5, 1, 3.5}, {1, 3.5, 0, 3}, {0, 3, 0, 1}, {0, 1, 1, 0},
		{1, 0, 4, 0}, {4, 0, 5, 1}, {5, 1, 5, 6}, {5, 6, 4, 7},
		{4, 7, 1, 7},
	},
	':': {
		{2, 2, 3, 2}, {3, 2, 3, 3}, {3, 3, 2, 3}, {2, 3, 2, 2},
		{2, 5, 3, 5}, {3, 5, 3, 6}, {3, 6, 2, 6}, {2, 6, 2, 5},
	},
	'.': {
		{2, 6, 3, 6}, {3, 6, 3, 7}, {3, 7, 2, 7}, {2, 7, 2, 6},
	},
	'!': {
		{2.5, 0, 2.5, 4.5},
		{2, 6, 3, 6}, {3, 6, 3, 7}, {3, 7, 2, 7}, {2, 7, 2, 6},
	},
	'?': {
		{0, 1, 1, 0}, {1, 0, 4, 0}, {4, 0, 5, 1}, {5, 1, 5, 3},
		{5, 3, 3, 4}, {3, 4, 2.5, 4.5},
		{2, 6, 3, 6}, {3, 6, 3, 7}, {3, 7, 2, 7}, {2, 7, 2, 6},
	},
	'-': {
		{1, 3.5, 4, 3.5},
	},
	' ': {},
}

// DrawText renders text using vector line segments.
func DrawText(screen *ebiten.Image, text string, x, y, scale float64, clr color.RGBA) {
	cx := x
	for _, ch := range text {
		if ch >= 'a' && ch <= 'z' {
			ch = ch - 'a' + 'A'
		}
		segs, ok := fontGlyphs[ch]
		if !ok {
			cx += 6 * scale
			continue
		}
		for _, s := range segs {
			x1 := cx + s[0]*scale
			y1 := y + s[1]*scale
			x2 := cx + s[2]*scale
			y2 := y + s[3]*scale
			w := float32(1.5)
			if scale > 4 {
				w = float32(scale * 0.4)
			}
			vector.StrokeLine(screen, float32(x1), float32(y1), float32(x2), float32(y2), w, clr, false)
		}
		cx += 6 * scale
	}
}

// TextWidth returns the pixel width of the given text at the given scale.
func TextWidth(text string, scale float64) float64 {
	if len(text) == 0 {
		return 0
	}
	return float64(len(text)) * 6 * scale
}
